name: Copy Uptime Kuma to GHCR - One Time Run

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼Œåªè¿è¡Œä¸€æ¬¡
    inputs:
      custom_tag:
        description: 'è‡ªå®šä¹‰æ ‡ç­¾ (å¯é€‰)'
        required: false
        default: 'stable'
      image_name:
        description: 'é•œåƒåç§°'
        required: false
        default: 'uptime-kuma'

jobs:
  copy-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull source image
        run: |
          echo "ğŸ“¥ æ­£åœ¨æ‹‰å–æºé•œåƒ..."
          docker pull ghcr.io/louislam/uptime-kuma:nightly2
          echo "âœ… æºé•œåƒæ‹‰å–å®Œæˆ"

      - name: Extract image metadata
        id: meta
        run: |
          # è·å–é•œåƒçš„åˆ›å»ºæ—¥æœŸ
          CREATED_DATE=$(docker inspect ghcr.io/louislam/uptime-kuma:nightly2 | jq -r '.[0].Created' | cut -d'T' -f1 | tr -d '-')
          echo "created_date=$CREATED_DATE" >> $GITHUB_OUTPUT
          
          # è·å–é•œåƒIDçš„å‰8ä½ä½œä¸ºçŸ­ID
          IMAGE_ID=$(docker images --no-trunc ghcr.io/louislam/uptime-kuma:nightly2 | awk 'NR==2 {print $3}' | cut -c 1-8)
          echo "image_id_short=$IMAGE_ID" >> $GITHUB_OUTPUT

      - name: Retag images
        run: |
          echo "ğŸ·ï¸  æ­£åœ¨é‡æ–°æ ‡è®°é•œåƒ..."
          
          # åŸºç¡€å˜é‡
          OWNER="${{ github.repository_owner }}"
          IMAGE_NAME="${{ github.event.inputs.image_name }}"
          CUSTOM_TAG="${{ github.event.inputs.custom_tag }}"
          CREATED_DATE="${{ steps.meta.outputs.created_date }}"
          IMAGE_ID="${{ steps.meta.outputs.image_id_short }}"
          
          # é‡æ–°æ‰“æ ‡ç­¾
          docker tag ghcr.io/louislam/uptime-kuma:nightly2 ghcr.io/$OWNER/$IMAGE_NAME:latest
          docker tag ghcr.io/louislam/uptime-kuma:nightly2 ghcr.io/$OWNER/$IMAGE_NAME:stable
          docker tag ghcr.io/louislam/uptime-kuma:nightly2 ghcr.io/$OWNER/$IMAGE_NAME:$CREATED_DATE
          docker tag ghcr.io/louislam/uptime-kuma:nightly2 ghcr.io/$OWNER/$IMAGE_NAME:$CUSTOM_TAG
          docker tag ghcr.io/louislam/uptime-kuma:nightly2 ghcr.io/$OWNER/$IMAGE_NAME:nightly2-$IMAGE_ID
          
          echo "âœ… é•œåƒæ ‡è®°å®Œæˆ"
          echo "åˆ›å»ºçš„æ ‡ç­¾:"
          echo "  - latest"
          echo "  - stable" 
          echo "  - $CREATED_DATE (åˆ›å»ºæ—¥æœŸ)"
          echo "  - $CUSTOM_TAG (è‡ªå®šä¹‰æ ‡ç­¾)"
          echo "  - nightly2-$IMAGE_ID (å¸¦IDçš„nightlyç‰ˆæœ¬)"

      - name: Push images to GHCR
        run: |
          echo "ğŸš€ æ­£åœ¨æ¨é€é•œåƒåˆ° GHCR..."
          
          OWNER="${{ github.repository_owner }}"
          IMAGE_NAME="${{ github.event.inputs.image_name }}"
          CUSTOM_TAG="${{ github.event.inputs.custom_tag }}"
          CREATED_DATE="${{ steps.meta.outputs.created_date }}"
          IMAGE_ID="${{ steps.meta.outputs.image_id_short }}"
          
          # æ¨é€æ‰€æœ‰æ ‡ç­¾
          docker push ghcr.io/$OWNER/$IMAGE_NAME:latest
          docker push ghcr.io/$OWNER/$IMAGE_NAME:stable
          docker push ghcr.io/$OWNER/$IMAGE_NAME:$CREATED_DATE
          docker push ghcr.io/$OWNER/$IMAGE_NAME:$CUSTOM_TAG
          docker push ghcr.io/$OWNER/$IMAGE_NAME:nightly2-$IMAGE_ID
          
          echo "âœ… æ‰€æœ‰é•œåƒæ¨é€å®Œæˆ"

      - name: Display summary
        run: |
          echo ""
          echo "ğŸ‰ å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼"
          echo "=========================================="
          echo "ğŸ“¦ é•œåƒå·²æˆåŠŸæ¨é€åˆ° GitHub Container Registry"
          echo "=========================================="
          echo ""
          echo "ğŸ“ é•œåƒåœ°å€: ghcr.io/${{ github.repository_owner }}/${{ github.event.inputs.image_name }}"
          echo ""
          echo "ğŸ·ï¸  å¯ç”¨çš„æ ‡ç­¾:"
          echo "   â€¢ latest (æ¨èä½¿ç”¨)"
          echo "   â€¢ stable"
          echo "   â€¢ ${{ steps.meta.outputs.created_date }} (åˆ›å»ºæ—¥æœŸ)"
          echo "   â€¢ ${{ github.event.inputs.custom_tag }} (è‡ªå®šä¹‰æ ‡ç­¾)"
          echo "   â€¢ nightly2-${{ steps.meta.outputs.image_id_short }} (å¸¦IDç‰ˆæœ¬)"
          echo ""
          echo "ğŸ”— æ‹‰å–ç¤ºä¾‹:"
          echo "   docker pull ghcr.io/${{ github.repository_owner }}/${{ github.event.inputs.image_name }}:latest"
          echo ""
          echo "ğŸ“‹ ä½¿ç”¨ docker-compose ç¤ºä¾‹:"
          echo "   image: ghcr.io/${{ github.repository_owner }}/${{ github.event.inputs.image_name }}:latest"
          echo ""
          echo "ğŸŒ æŸ¥çœ‹é•œåƒ:"
          echo "   è®¿é—® https://github.com/${{ github.repository_owner }}?tab=packages"
          echo "=========================================="
