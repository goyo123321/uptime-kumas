name: Copy Uptime Kuma to GHCR - One Time Run

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼Œåªè¿è¡Œä¸€æ¬¡
    inputs:
      custom_tag:
        description: 'è‡ªå®šä¹‰æ ‡ç­¾ (å¯é€‰)'
        required: false
        default: 'stable'

jobs:
  copy-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull source image
        run: |
          echo "ğŸ“¥ æ­£åœ¨æ‹‰å–æºé•œåƒ..."
          docker pull ghcr.io/louislam/uptime-kuma:nightly2
          echo "âœ… æºé•œåƒæ‹‰å–å®Œæˆ"

      - name: Extract image metadata
        id: meta
        run: |
          # è·å–é•œåƒçš„åˆ›å»ºæ—¥æœŸ
          CREATED_DATE=$(docker inspect ghcr.io/louislam/uptime-kuma:nightly2 | jq -r '.[0].Created' | cut -d'T' -f1 | tr -d '-')
          echo "created_date=$CREATED_DATE" >> $GITHUB_OUTPUT
          
          # è·å–é•œåƒIDçš„å‰8ä½ï¼ˆåªä¿ç•™å­—æ¯æ•°å­—ï¼‰
          IMAGE_ID=$(docker images --quiet ghcr.io/louislam/uptime-kuma:nightly2 | cut -c 1-12)
          CLEAN_IMAGE_ID=$(echo "$IMAGE_ID" | tr -d '[:punct:]')
          echo "image_id_short=$CLEAN_IMAGE_ID" >> $GITHUB_OUTPUT
          echo "é•œåƒID: $IMAGE_ID, æ¸…ç†å: $CLEAN_IMAGE_ID"

      - name: Retag images
        run: |
          echo "ğŸ·ï¸  æ­£åœ¨é‡æ–°æ ‡è®°é•œåƒ..."
          
          # å›ºå®šé•œåƒåç§°
          TARGET_IMAGE="ghcr.io/goyo123321/uptime-kuma"
          CUSTOM_TAG="${{ github.event.inputs.custom_tag }}"
          CREATED_DATE="${{ steps.meta.outputs.created_date }}"
          IMAGE_ID="${{ steps.meta.outputs.image_id_short }}"
          
          echo "ç›®æ ‡é•œåƒ: $TARGET_IMAGE"
          echo "è‡ªå®šä¹‰æ ‡ç­¾: $CUSTOM_TAG"
          echo "åˆ›å»ºæ—¥æœŸ: $CREATED_DATE"
          echo "é•œåƒID: $IMAGE_ID"
          
          # é‡æ–°æ‰“æ ‡ç­¾ - ä½¿ç”¨å®‰å…¨çš„æ ‡ç­¾åç§°
          docker tag ghcr.io/louislam/uptime-kuma:nightly2 $TARGET_IMAGE:latest
          docker tag ghcr.io/louislam/uptime-kuma:nightly2 $TARGET_IMAGE:stable
          docker tag ghcr.io/louislam/uptime-kuma:nightly2 $TARGET_IMAGE:$CREATED_DATE
          docker tag ghcr.io/louislam/uptime-kuma:nightly2 $TARGET_IMAGE:$CUSTOM_TAG
          
          # åªæœ‰å½“IMAGE_IDä¸ä¸ºç©ºä¸”æœ‰æ•ˆæ—¶æ‰åˆ›å»ºå¸¦IDçš„æ ‡ç­¾
          if [ -n "$IMAGE_ID" ] && [ "$IMAGE_ID" != "null" ]; then
            docker tag ghcr.io/louislam/uptime-kuma:nightly2 $TARGET_IMAGE:nightly2-$IMAGE_ID
            echo "âœ… åˆ›å»ºäº†å¸¦IDçš„æ ‡ç­¾: nightly2-$IMAGE_ID"
          else
            echo "âš ï¸  æ— æ³•è·å–æœ‰æ•ˆçš„é•œåƒIDï¼Œè·³è¿‡åˆ›å»ºå¸¦IDçš„æ ‡ç­¾"
          fi
          
          echo "âœ… é•œåƒæ ‡è®°å®Œæˆ"

      - name: Push images to GHCR
        run: |
          echo "ğŸš€ æ­£åœ¨æ¨é€é•œåƒåˆ° GHCR..."
          
          TARGET_IMAGE="ghcr.io/goyo123321/uptime-kuma"
          CUSTOM_TAG="${{ github.event.inputs.custom_tag }}"
          CREATED_DATE="${{ steps.meta.outputs.created_date }}"
          IMAGE_ID="${{ steps.meta.outputs.image_id_short }}"
          
          # æ¨é€åŸºç¡€æ ‡ç­¾
          docker push $TARGET_IMAGE:latest
          docker push $TARGET_IMAGE:stable
          docker push $TARGET_IMAGE:$CREATED_DATE
          docker push $TARGET_IMAGE:$CUSTOM_TAG
          
          # åªæœ‰å½“IMAGE_IDä¸ä¸ºç©ºä¸”æœ‰æ•ˆæ—¶æ‰æ¨é€å¸¦IDçš„æ ‡ç­¾
          if [ -n "$IMAGE_ID" ] && [ "$IMAGE_ID" != "null" ]; then
            docker push $TARGET_IMAGE:nightly2-$IMAGE_ID
          fi
          
          echo "âœ… æ‰€æœ‰é•œåƒæ¨é€å®Œæˆ"

      - name: Display summary
        run: |
          echo ""
          echo "ğŸ‰ å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼"
          echo "=========================================="
          echo "ğŸ“¦ é•œåƒå·²æˆåŠŸæ¨é€åˆ° GitHub Container Registry"
          echo "=========================================="
          echo ""
          echo "ğŸ“ é•œåƒåœ°å€: ghcr.io/goyo123321/uptime-kuma"
          echo ""
          echo "ğŸ·ï¸  å¯ç”¨çš„æ ‡ç­¾:"
          echo "   â€¢ latest (æ¨èä½¿ç”¨)"
          echo "   â€¢ stable"
          echo "   â€¢ ${{ steps.meta.outputs.created_date }} (åˆ›å»ºæ—¥æœŸ)"
          echo "   â€¢ ${{ github.event.inputs.custom_tag }} (è‡ªå®šä¹‰æ ‡ç­¾)"
          if [ -n "${{ steps.meta.outputs.image_id_short }}" ] && [ "${{ steps.meta.outputs.image_id_short }}" != "null" ]; then
            echo "   â€¢ nightly2-${{ steps.meta.outputs.image_id_short }} (å¸¦IDç‰ˆæœ¬)"
          fi
          echo ""
          echo "ğŸ”— æ‹‰å–ç¤ºä¾‹:"
          echo "   docker pull ghcr.io/goyo123321/uptime-kuma:latest"
          echo ""
          echo "ğŸ“‹ ä½¿ç”¨ docker-compose ç¤ºä¾‹:"
          echo "   image: ghcr.io/goyo123321/uptime-kuma:latest"
          echo ""
          echo "ğŸŒ æŸ¥çœ‹é•œåƒ:"
          echo "   è®¿é—® https://github.com/goyo123321?tab=packages"
          echo "=========================================="
